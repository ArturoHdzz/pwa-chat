<app-chat-header
  [title]="'Tareas'"
  [timeLabel]="'11:15'"
  (organizationChange)="onOrgChange($event)"
>
</app-chat-header>

<app-spiner [show]="isLoading()" [message]="loadmessage()"></app-spiner>

<ion-content class="bg-gray-100" fullscreen>

  <div class="px-4 pt-3 pb-20">

    <!-- Título -->
    <ion-item lines="none" class="!bg-transparent !px-0">
      <ion-label>
        <h3 class="text-xl font-semibold text-gray-900">
          Mis tareas
        </h3>
        <p class="text-xs text-gray-500 mt-1">
          Aquí puedes ver tus tareas asignadas, fechas de entrega y calificaciones.
        </p>
      </ion-label>
    </ion-item>

    <!-- Sin tareas -->
    <ion-item
      *ngIf="tasks().length === 0"
      lines="none"
      class="mt-6 !bg-transparent !px-0"
    >
      <ion-label class="ion-text-center text-sm text-gray-500">
        No tienes tareas asignadas por el momento.
      </ion-label>
    </ion-item>

    <!-- Lista de tareas -->
    <ion-list lines="none" class="mt-2 !bg-transparent">
      <ion-card
        *ngFor="let t of tasks()"
        class="mb-3 rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
      >
        <!-- Header -->
        <ion-item lines="none" class="!bg-transparent !px-0 mt-3">
          <ion-label>
            <h2 class="text-[16px] font-semibold text-gray-900 leading-snug tracking-tight mb-1">
              {{ t.title }}
            </h2>

            <p class="text-xs text-gray-500 mt-1">
              {{ t.group?.name || 'Tarea individual' }}
            </p>
          </ion-label>

          <!-- Estado -->
          <ion-chip
            class="text-[11px] font-medium"
            [ngClass]="getStatusColor(t.my_status || '')"
            mode="md"
          >
            <ion-label>{{ t.my_status | titlecase }}</ion-label>
          </ion-chip>
        </ion-item>

        <!-- Descripción -->
        <ion-card-content *ngIf="t.description" class="pt-0 pb-1">
          <p class="text-[13px] text-gray-600 line-clamp-2">
            {{ t.description }}
          </p>
        </ion-card-content>

        <!-- Footer: fecha + calificación + acciones -->
        <ion-card-content class="pt-1 pb-3">
          <ion-grid class="p-0 text-[11px] text-gray-500">
            <ion-row class="items-center">
              <!-- Fecha de entrega -->
              <ion-col size="7" class="flex items-center gap-1.5">
                <span class="inline-block h-2 w-2 rounded-full bg-amber-400"></span>
                <span class="font-medium">
                  Entrega:
                </span>
                <span>
                  {{ t.due_at | date: 'short' }}
                </span>
              </ion-col>

              <!-- Calificación + botones -->
              <ion-col size="5" class="ion-text-right">
                <div class="flex items-center justify-end gap-2">

                  <!-- Calificación -->
                  <div *ngIf="t.my_grade !== null" class="flex items-center gap-1">
                    <span class="text-gray-400">Calificación:</span>
                    <ion-badge
                      [ngClass]="
                        (t.my_grade ?? 0) >= 70
                          ? 'bg-emerald-100 text-emerald-700'
                          : 'bg-rose-100 text-rose-700'
                      "
                      class="rounded-full px-2 py-1 text-[11px] font-semibold"
                    >
                      {{ t.my_grade }}/100
                    </ion-badge>
                  </div>

                  <!-- Botones acción -->
                  <ion-buttons class="gap-1">
                    <ion-button
                      *ngIf="t.my_status === 'pending'"
                      size="small"
                      fill="outline"
                      (click)="markInProgress(t)"
                      [disabled]="isActionLoading()"
                      class="rounded-full text-[11px] !px-2 !py-0"
                    >
                      Empezar
                    </ion-button>

                    <ion-button
                      *ngIf="t.my_status === 'pending' || t.my_status === 'in_progress'"
                      size="small"
                      fill="solid"
                      color="primary"
                      (click)="openSubmitForm(t)"
                      [disabled]="isActionLoading()"
                      class="rounded-full text-[11px] !px-2 !py-0"
                    >
                      Entregar
                    </ion-button>
                  </ion-buttons>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Formulario de entrega -->
          <div
            *ngIf="activeTaskId() === t.id"
            class="mt-3 rounded-2xl bg-gray-50 border border-gray-100 p-3 space-y-2"
          >
            <!-- Texto de respuesta -->
            <ion-item lines="none" class="!bg-transparent !px-0">
              <ion-textarea
                autoGrow="true"
                rows="3"
                placeholder="Escribe tu respuesta o comentarios..."
                class="text-[13px]"
                [ngModel]="submissionText()"
                (ngModelChange)="submissionText.set($event)"
              ></ion-textarea>
            </ion-item>

            <!-- Archivo + acciones -->
            <ion-item lines="none" class="!bg-transparent !px-0">
              <ion-grid class="p-0">
                <ion-row class="items-center">
                  <!-- Selector de archivo -->
                  <ion-col size="7" class="flex items-center gap-2">
                    <!-- input real oculto -->
                    <input
                      #fileInput
                      type="file"
                      class="hidden"
                      (change)="onFileChange($event)"
                    />

                    <!-- Botón Ionic para adjuntar -->
                    <ion-button
                      type="button"
                      fill="outline"
                      size="small"
                      (click)="fileInput.click()"
                      class="!m-0 rounded-full border-dashed
                             px-3 py-1 text-[11px]"
                    >
                      <ion-icon slot="start" name="attach-outline"></ion-icon>
                      Adjuntar archivo
                    </ion-button>

                    <!-- Nombre del archivo -->
                    <ion-chip
                      *ngIf="selectedFileName()"
                      outline="true"
                      color="medium"
                      class="max-w-[150px] truncate"
                    >
                      <ion-icon name="document-outline"></ion-icon>
                      <ion-label class="truncate">
                        {{ selectedFileName() }}
                      </ion-label>
                      <ion-icon
                        name="close-circle"
                        (click)="clearFile()"
                      ></ion-icon>
                    </ion-chip>
                  </ion-col>

                  <!-- Botones Enviar / Cancelar -->
                  <ion-col size="5" class="ion-text-right">
                    <ion-buttons class="justify-end gap-1">
                      <ion-button
                        size="small"
                        fill="clear"
                        color="medium"
                        (click)="cancelSubmitForm()"
                        [disabled]="isActionLoading()"
                        class="rounded-full text-[11px]"
                      >
                        Cancelar
                      </ion-button>

                      <ion-button
                        size="small"
                        fill="solid"
                        color="primary"
                        (click)="submitCurrentTask()"
                        [disabled]="isActionLoading()"
                        class="rounded-full text-[11px]"
                      >
                        Enviar tarea
                      </ion-button>
                    </ion-buttons>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-item>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>
  </div>
</ion-content>
